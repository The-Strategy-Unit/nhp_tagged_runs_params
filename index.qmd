---
title: "Automated extraction of NHP tagged-run params"
date: "last-modified"
date-format: D MMM YYYY HH:mm
format: html
---

```{r}
#| label: check-env-vars
#| results: "asis"
#| echo: false

required_env_vars <- c(
  "AZ_STORAGE_EP",
  "AZ_STORAGE_CONTAINER_RESULTS",
  "AZ_TABLE_EP",
  "AZ_TABLE_NAME",
  "NHP_ENCRYPT_KEY"
)
if (any(Sys.getenv(required_env_vars) == "")) {
  cat("One of the following environment variables was not set, so exiting \n\n")
  cat(paste("*", required_env_vars, collapse = "\n"), "\n\n")
  knitr::knit_exit()
}
```

```{r}
#| label: setup
#| echo: false

source("R/azure.R")
source("R/params.R")
source("R/pin.R")
```

## Purpose

A Quarto document deployed to Posit Connect that runs on schedule.
The source is in the [The-Strategy-Unit/nhp_tagged_runs_params](https://github.com/The-Strategy-Unit/nhp_tagged_runs_params) GitHub repo.

Generates and [pins](https://pins.rstudio.com/):

* a list object containing the model params for each NHP scheme's latest [tagged model run](https://connect.strategyunitwm.nhs.uk/nhp/tagged_runs)
* a data.frame object containing metadata associated with the tagged runs

The pins make it easier and faster to ingest params data into products like [the mitigators-comparison app](https://github.com/The-Strategy-Unit/nhp_inputs_report_app), for example.
This is a workaround because the results files are very large but certain tasks only require the params component.
In future, the params and results files will be stored separately, reducing the need for this functionality.

## Products

You can access on Posit Connect (login- and permissions-dependent):

* the params pin at [matt.dray/nhp_tagged_runs_params](https://connect.strategyunitwm.nhs.uk/content/32c7f642-e420-448d-b888-bf655fc8fa8b/)
* the params metadata pin at [matt.dray/nhp_tagged_runs_meta](https://connect.strategyunitwm.nhs.uk/content/811dbaf9-18fe-43aa-bf8e-06b0df66004e/)

## Code

The steps in this report are to:

1. Read from Azure table storage the metadata for results files that have a run-stage.
1. Pin their metadata.
1. Read the params from the corresponding JSON files in Azure blob storage and add them to a named list.
1. Pin the params.

The pins will not be updated if there is no new data.

### Boards

Connect to the board that contains the pins used in this process.

```{r}
#| label: board-connect

board <- pins::board_connect(server = "connect.strategyunitwm.nhs.uk")
```

### Metadata

#### Data

Results files are stored in an Azure storage container.

```{r}
#| label: get-containers

container_results <- connect_az_container(
  container_name = Sys.getenv("AZ_STORAGE_CONTAINER_RESULTS")
)
```

Read from Azure Table Storage the metadata for runs that have a run stage.
```{r}
#| label: get-meta

meta <- read_az_table() |> prepare_az_table()
knitr::kable(meta)
```

#### Pin

Pin the metadata to the board. The `pin_if_board_exists()` function will only write the pin if a connection to the board has been successful.

```{r}
#| label: pin-meta

pin_if_board_exists(board, meta, "matt.dray/nhp_tagged_runs_meta")
```

### Params

#### Data

Given the metadata, read the corresponding `file` for each model run.
The `get_all_params()` function will read from the standalone `params.json` of new-style aggregated results, otherwise it falls back to unzipping the old-style `.json.gz` file and extracting the `params` element.

```{r}
#| label: get-params

params_list <- get_all_params(meta, container_results)
names(params_list)
```

#### Pin

Pin the params (if possible, depending on board availability).

```{r}
#| label: pin-params

pin_if_board_exists(board, params_list, "matt.dray/nhp_tagged_runs_params")
pin_if_board_exists(board_new, params_list, "matt.dray/nhp_tagged_runs_params")
```
